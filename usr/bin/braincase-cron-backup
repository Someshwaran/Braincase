#!/bin/bash

# Author:	Robert McLeod
# Date:		21 August 2012
# Desc:		Turns on brainbase backups by adding a line to the crontab

# Check if we are root
if [ $UID != 0 ]; then
	echo "This script needs to run as root";
	exit 1;
fi;

# The cron string for running backups
CRONTAB_STRING="0 0 * * * root braincase-backup --run";
CRONTAB_STRING_SAFE="0 0 \* \* \* root braincase-backup --run";

function backups_enabled() {
	
	if [ "$(grep "$CRONTAB_STRING_SAFE" /etc/crontab|wc -l)" = 0 ]; then
		echo "false";
	else
		echo "true";
	fi;
}

# Check what the command line specified
case "$1" in
"-e") # enable
	if [ "$(backups_enabled)" = "true" ]; then
		exit 0;
	fi;

	echo "$CRONTAB_STRING"  >> /etc/crontab # put our line into the crontab

	if [ "$(backups_enabled)" = "false" ]; then
		echo "Braincase backups could not be enabled in crontab.";
		exit 1;
	fi;
	;;
"-d") # disable
	if [ "$(backups_enabled)" = "false" ]; then
		exit 0;
	fi;

	cp /etc/crontab /etc/crontab.old; 				# backup the crontab just incase
	cat /etc/crontab | grep -v "$CRONTAB_STRING_SAFE" > /tmp/crontab 	# remove our line from crontab
	cp /tmp/crontab /etc/crontab;					# move the changes to crontab

	if [ "$(backups_enabled)" = "true" ]; then
		echo "Braincase backups could not be disabled in crontab";
		exit 1;
	fi;

	exit 0;
	;;
"")
	if [ "$(backups_enabled)" = "true" ]; then
		echo "Braincase backups are enabled";
	else
		echo "Braincase backups are disabled";
	fi;
	;;
*) # show usage otherwise
	echo "Usage: braincase-cron-backup <-e|-d>";
	echo "\t-e\tEnables backup operations every midnight";
	echo "\t-d\tDisables backup operations every midnight";
	exit 1;
esac
