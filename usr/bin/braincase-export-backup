#!/bin/bash

# Check what needs to be exported to run the appropriate function
function do_exports() {
	EXPORTS="$1";
	FILENAME="$2";

	# Dropbox?
	echo $EXPORTS | grep dropbox
	if [ "$?" = "0" ]; then # grep found dropbox
		braincase-export-to-dropbox "$FILENAME";
	fi;
}

# Setup the variables
USER="$1";

if [ "$USER" != "" ] 					# if a user was specified at command line
&& [ $UID != 0 ] 						# and we are not root
&& [ "$USER" != "$((whoami))" ]; then	# and we are not the user specified
	echo "You must be root or $USER to export $USERS backup";
	exit 1;								# then deny access
fi;

# If no user specified at command use us
if [ "$USER" = "" ]; then
	USER=`whoami`;
fi;

HOME="/home/$USER";
CONFIG="$HOME/.braincase/config";

# Check if a user was given
if [ "$USER" = "" ]; then
	echo "Usage: braincase-export-backup <username>";
	exit 1;
fi;

# Check the user exists
user-exists $USER;
if [ "$?" = "1" ]; then
	echo "User $USER does not exist";
	exit 1;
fi;

# Check home exists
if [ -e $HOME ]; then
	echo "Cannot find the homedir for $USER";
	exit 1;
fi;

# Check if exporting backups is enabled
if [ "$((braincase-config $USER.export_backups))" = "false" ]; then
	echo "Backup exporting disabled for $USER";
	exit 1;
fi;

# OK get the file we need to export
$FILENAME="cat $HOME/backups/latest";

# Check what we need to export to
do_exports `braincase-config $USER.export_to` $FILENAME;