#!/bin/bash

# Check the current user is root
if [ "$UID" != 0 ]; then
	echo "You must be root to use this script.";
	exit 1;
fi;

function usage() {
	echo "Usage: braincase-export-backup <username>";
}

# Check what needs to be exported to run the appropriate function
function do_exports() {
	EXPORTS="$1";
	FILENAME="$2";

	# Dropbox?
	echo $EXPORTS | grep dropbox
	if [ "$?" = "0" ]; then # grep found dropbox
		braincase-export-to-dropbox "$FILENAME";
	fi;
}

# Make sure a user was specified at command line
if [ "$1" != "" ]; then
	usage;
	exit 1;
fi;

# Setup the variables
USER="$1";
HOME="/home/$USER";
CONFIG="$HOME/.braincase/config";

# Check if a user was given
if [ "$USER" = "" ]; then
	echo "Usage: braincase-export-backup <username>";
	exit 1;
fi;

# Check the user exists
user-exists $USER;
if [ "$?" = "1" ]; then
	echo "User $USER does not exist";
	exit 1;
fi;

# Check home exists
if [ -e $HOME ]; then
	echo "Cannot find the homedir for $USER";
	exit 1;
fi;

# Check if exporting backups is enabled
if [ "$((braincase-config $USER.export_backups))" = "false" ]; then
	echo "Backup exporting disabled for $USER";
	exit 1;
fi;

# OK get the file we need to export
$FILENAME="cat $HOME/backups/latest";

# Check what we need to export to
do_exports `braincase-config $USER.export_to` $FILENAME;